<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>OSSEC Host Intrusion Detection System | Libellux</title>
    <meta name="generator" content="VuePress 1.5.3">
    <link rel="icon" href="https://docs.libellux.com/img/icons/72x72.png">
    <link rel="apple-touch-icon" sizes="48x48" href="https://docs.libellux.com/img/icons/48x48.png">
    <link rel="apple-touch-icon" sizes="72x72" href="https://docs.libellux.com/img/icons/72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="https://docs.libellux.com/img/icons/144x144.png">
    <link rel="apple-touch-icon" sizes="192x192" href="https://docs.libellux.com/img/icons/192x192.png">
    <link rel="apple-touch-icon" sizes="256x256" href="https://docs.libellux.com/img/icons/256x256.png">
    <link rel="apple-touch-icon" sizes="384x384" href="https://docs.libellux.com/img/icons/384x384.png">
    <link rel="apple-touch-icon" sizes="512x512" href="https://docs.libellux.com/img/icons/512x512.png">
    <link rel="apple-touch-icon" sizes="1200x627" href="https://docs.libellux.com/img/icons/1200x627.png">
    <meta name="description" content="OSSEC open-source host-based intrusion detection system">
    <meta name="robots" content="index, follow">
    <meta name="Twitterbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
    <meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
    <meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:creator" content="@libellux1">
    <meta name="twitter:title" content="Libellux: Up and Running">
    <meta name="twitter:description" content="Libellux: Up and Running is a collection of personal notes and documentation regarding open-source software configuration.">
    <meta name="twitter:image" content="https://docs.libellux.com/img/icons/4096x4096.png">
    <meta name="twitter:width" content="4096">
    <meta name="twitter:height" content="4096">
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Libellux: Up and Running">
    <meta property="og:description" content="Libellux: Up and Running is a collection of personal notes and documentation regarding open-source software configuration.">
    <meta property="og:url" content="https://docs.libellux.com">
    <meta property="og:site_name" content="Libellux: Up and Running">
    <meta property="og:publisher" content="https://www.facebook.com/libellux1">
    <meta property="og:author" content="https://www.facebook.com/fredrik.hilmersson.1">
    <meta property="og:image" content="https://docs.libellux.com/img/icons/1200x627.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="627">
    <meta name="msapplication-TileImage" content="https://docs.libellux.com/img/icons/144x144.png">
    <link rel="preload" href="/assets/css/0.styles.75739d6a.css" as="style"><link rel="preload" href="/assets/js/app.05a4ee0a.js" as="script"><link rel="preload" href="/assets/js/2.716680d4.js" as="script"><link rel="preload" href="/assets/js/14.98e47507.js" as="script"><link rel="preload" href="/assets/js/5.06c58baa.js" as="script"><link rel="preload" href="/assets/js/4.99009925.js" as="script"><link rel="preload" href="/assets/js/3.8dada23c.js" as="script"><link rel="prefetch" href="/assets/js/10.c94c30dd.js"><link rel="prefetch" href="/assets/js/11.1bab45d4.js"><link rel="prefetch" href="/assets/js/12.73349990.js"><link rel="prefetch" href="/assets/js/13.20e1da4b.js"><link rel="prefetch" href="/assets/js/15.1aa6eab8.js"><link rel="prefetch" href="/assets/js/16.a2b8c0cb.js"><link rel="prefetch" href="/assets/js/17.79849525.js"><link rel="prefetch" href="/assets/js/18.d9a6bb37.js"><link rel="prefetch" href="/assets/js/19.13f48a13.js"><link rel="prefetch" href="/assets/js/20.966af82d.js"><link rel="prefetch" href="/assets/js/6.a68e6a00.js"><link rel="prefetch" href="/assets/js/7.8497ab7c.js"><link rel="prefetch" href="/assets/js/8.761b8acb.js"><link rel="prefetch" href="/assets/js/9.b26a5461.js">
    <link rel="stylesheet" href="/assets/css/0.styles.75739d6a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/icons/72x72.png" alt="Libellux" class="logo"> <span class="site-name can-hide">Libellux</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Libellux: Up and Running
</a></div> <a href="https://github.com/libellux/Libellux-Up-and-Running" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Libellux: Up and Running
</a></div> <a href="https://github.com/libellux/Libellux-Up-and-Running" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">Libellux: Up and Running</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Zero Trust Network</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Intrusion Detection and Prevention</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/ossec/" aria-current="page" class="active sidebar-link">OSSEC Host Intrusion Detection</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ossec/#configuration-files" class="sidebar-link">Configuration files</a></li><li class="sidebar-sub-header"><a href="/ossec/#prerequisites" class="sidebar-link">Prerequisites</a></li><li class="sidebar-sub-header"><a href="/ossec/#server-installation" class="sidebar-link">Server installation</a></li><li class="sidebar-sub-header"><a href="/ossec/#server-configuration" class="sidebar-link">Server configuration</a></li><li class="sidebar-sub-header"><a href="/ossec/#agent-installation" class="sidebar-link">Agent installation</a></li><li class="sidebar-sub-header"><a href="/ossec/#agent-configuration" class="sidebar-link">Agent configuration</a></li><li class="sidebar-sub-header"><a href="/ossec/#manage-agents" class="sidebar-link">Manage agents</a></li><li class="sidebar-sub-header"><a href="/ossec/#firewall-settings" class="sidebar-link">Firewall settings</a></li><li class="sidebar-sub-header"><a href="/ossec/#slack-integration" class="sidebar-link">Slack integration</a></li><li class="sidebar-sub-header"><a href="/ossec/#cloudflare-integration" class="sidebar-link">Cloudflare integration</a></li><li class="sidebar-sub-header"><a href="/ossec/#monitoring" class="sidebar-link">Monitoring</a></li><li class="sidebar-sub-header"><a href="/ossec/#upgrading" class="sidebar-link">Upgrading</a></li><li class="sidebar-sub-header"><a href="/ossec/#custom-rules" class="sidebar-link">Custom rules</a></li><li class="sidebar-sub-header"><a href="/ossec/#command-line" class="sidebar-link">Command-line</a></li><li class="sidebar-sub-header"><a href="/ossec/#troubleshooting" class="sidebar-link">Troubleshooting</a></li><li class="sidebar-sub-header"><a href="/ossec/#recommended-reading" class="sidebar-link">Recommended reading</a></li><li class="sidebar-sub-header"><a href="/ossec/#enterprise-solutions" class="sidebar-link">Enterprise solutions</a></li></ul></li><li><a href="/psad/" class="sidebar-link">PSAD Intrusion Detection</a></li><li><a href="/openvas/" class="sidebar-link">OpenVAS Vulnerability Scanner</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ossec-host-intrusion-detection-system"><a href="#ossec-host-intrusion-detection-system" class="header-anchor">#</a> OSSEC Host Intrusion Detection System</h1> <div>
  Tags:
  <a href="/tags.html#intrusion-detection">
    intrusion-detection
  </a><a href="/tags.html#intrusion-prevention">
    intrusion-prevention
  </a><a href="/tags.html#hids">
    hids
  </a><a href="/tags.html#security">
    security
  </a></div> <p>OSSEC is a full platform to monitor and control your systems. It mixes together all the aspects of HIDS (host-based intrusion detection), log monitoring and SIM/SIEM together in a simple, powerful and open source solution.</p> <p><a href="https://www.ossec.net/" target="_blank" rel="noopener noreferrer">OSSEC website<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="https://github.com/ossec/ossec-hids" target="_blank" rel="noopener noreferrer">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>Setup and configuration has been tested on following OS with version:</p> <ul><li>Ubuntu- 16.04, 18.04, 20.04</li> <li>2.9.0 -&gt; 3.6.0</li></ul> <h2 id="configuration-files"><a href="#configuration-files" class="header-anchor">#</a> Configuration files</h2> <ul><li><a href="https://github.com/libellux/Libellux-Up-and-Running/blob/master/docs/ossec/config/ossec.conf" target="_blank" rel="noopener noreferrer">ossec.conf<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> (server)</li> <li><a href="https://github.com/libellux/Libellux-Up-and-Running/blob/master/docs/ossec/config/ossec.conf_agent" target="_blank" rel="noopener noreferrer">ossec.conf<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> (agent)</li> <li><a href="https://github.com/libellux/Libellux-Up-and-Running/blob/master/docs/ossec/config/local_rules.xml" target="_blank" rel="noopener noreferrer">local_rules.xml<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h2 id="prerequisites"><a href="#prerequisites" class="header-anchor">#</a> Prerequisites</h2> <ul><li><code>build-essential</code></li> <li><code>libssl-dev</code></li> <li><code>libpcre2-dev</code></li> <li><code>zlib1g-dev</code></li> <li><code>jq</code> (optional)</li> <li><code>pcre2</code> library for version &gt;= 3.3.0 (<a href="https://ftp.pcre.org/pub/pcre/" target="_blank" rel="noopener noreferrer">ftp.pcre.org<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)</li></ul> <h2 id="server-installation"><a href="#server-installation" class="header-anchor">#</a> Server installation</h2> <p>Download the <a href="https://github.com/ossec/ossec-hids/releases" target="_blank" rel="noopener noreferrer">latest stable version<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> from ossec-hids GitHub. Extract the file and run the installation script. If receiving build errors, make sure that you have installed all the required dependencies or check the <a href="#troubleshooting">troubleshooting section</a> for details.</p> <div class="language-console extra-class"><pre class="language-text"><code>server@ubuntu:~$ wget https://github.com/ossec/ossec-hids/archive/3.6.0.tar.gz
server@ubuntu:~$ tar -zxvf 3.6.0.tar.gz
server@ubuntu:~$ cd ossec-hids-3.6.0/
server@ubuntu:~$ wget https://ftp.pcre.org/pub/pcre/pcre2-10.32.tar.gz
server@ubuntu:~$ tar -zxvf pcre2-10.32.tar.gz -C src/external/
server@ubuntu:~$ sudo apt-get install build-essential libssl-dev libpcre2-dev zlib1g-dev
server@ubuntu:~$ sudo PCRE2_SYSTEM=yes ./install.sh
</code></pre></div><p>In this setup we will not use e-mail notifications as we will be using Slack as our notification channel. We won't be adding IP addresses to our allow list now but in a later segment.</p> <div class="language-console extra-class"><div class="highlight-lines"><br><div class="highlighted"> </div><br><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-text"><code>[sudo] password for user: (en/br/cn/de/el/es/fr/hu/it/jp/nl/pl/ru/sr/tr) [en]: ENTER
What kind of installation do you want (server, agent, local, hybrid or help)? server
Choose where to install the OSSEC HIDS [/var/ossec/]: ENTER
Do you want e-mail notification? (y/n) [y]: n
Do you want to run the integrity check daemon? (y/n) [y]: y
Do you want to run the rootkit detection engine? (y/n) [y]: y
Do you want to enable active response? (y/n) [y]: y
Do you want to enable the firewall-drop response? (y/n) [y]: y
Do you want to add more IPs to the white list? (y/n)? [n]: n
Do you want to enable remote syslog (port 514 udp)? (y/n) [y]: y
--- Press ENTER to finish (maybe more information below). ---
</code></pre></div><h2 id="server-configuration"><a href="#server-configuration" class="header-anchor">#</a> Server configuration</h2> <h3 id="allow-list"><a href="#allow-list" class="header-anchor">#</a> Allow list</h3> <p>In the global section of the OSSEC configuration file add the IP addresses of the client(s) and services (e.g. OpenVAS) to allow.</p> <div class="language-console extra-class"><pre class="language-text"><code>server@ubuntu:~$ sudo nano /var/ossec/etc/ossec.conf
</code></pre></div><div class="language-xml extra-class"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>global</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>allow_list</span><span class="token punctuation">&gt;</span></span>127.0.0.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>allow_list</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>allow_list</span><span class="token punctuation">&gt;</span></span>::1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>allow_list</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>allow_list</span><span class="token punctuation">&gt;</span></span>localhost.localdomain<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>allow_list</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>allow_list</span><span class="token punctuation">&gt;</span></span>127.0.0.53<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>allow_list</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>allow_list</span><span class="token punctuation">&gt;</span></span>192.168.0.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>allow_list</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!-- OSSEC client --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>global</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="remote-syslog"><a href="#remote-syslog" class="header-anchor">#</a> Remote syslog</h3> <p>To enable the function to harvest syslog we need to establish that our remote client connection is secure and then allow it. Add the client IP address within the remote section.</p> <div class="language-console extra-class"><pre class="language-text"><code>server@ubuntu:~$ sudo nano /var/ossec/etc/ossec.conf
</code></pre></div><div class="language-xml extra-class"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br></div><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>remote</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>connection</span><span class="token punctuation">&gt;</span></span>secure<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>connection</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>allowed-ips</span><span class="token punctuation">&gt;</span></span>192.168.0.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>allowed-ips</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!-- OSSEC client --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>remote</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="repeated-offenders"><a href="#repeated-offenders" class="header-anchor">#</a> Repeated offenders</h3> <p>The first time an IP is blocked it will be put on timeout for the default 600 seconds. If the IP is blocked again it will follow the defined repeated offenders list. To enable repeated offenders, add the entry in the active response config.</p> <div class="custom-block warning"><p class="custom-block-title">NOTE</p> <p>Make sure that you add the repeated offenders entry at the top of the active response section in the ossec.conf file.</p></div> <div class="language-console extra-class"><pre class="language-text"><code>server@ubuntu:~$ sudo nano /var/ossec/etc/ossec.conf
</code></pre></div><div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!-- Active Response Config --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>active-response</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- Specify a comma seperated list of timeouts per
    - re-incidence (in minutes).
    --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repeated_offenders</span><span class="token punctuation">&gt;</span></span>30,60,120,240,480<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repeated_offenders</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>active-response</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Save the config and restart OSSEC to confirm that the repeated offenders been added.</p> <div class="language-console extra-class"><pre class="language-text"><code>server@ubuntu:~$ sudo /var/ossec/bin/ossec-control restart
Starting OSSEC HIDS v3.6.0...
2020/08/06 14:38:31 ossec-execd: INFO: Adding offenders timeout: 30 (for #1)
2020/08/06 14:38:31 ossec-execd: INFO: Adding offenders timeout: 60 (for #2)
2020/08/06 14:38:31 ossec-execd: INFO: Adding offenders timeout: 120 (for #3)
2020/08/06 14:38:31 ossec-execd: INFO: Adding offenders timeout: 240 (for #4)
2020/08/06 14:38:31 ossec-execd: INFO: Adding offenders timeout: 480 (for #5)
Started ossec-execd...
Started ossec-analysisd...
Started ossec-logcollector...
Started ossec-remoted...
Started ossec-syscheckd...
Started ossec-monitord...
Completed.
</code></pre></div><h3 id="psad-rules"><a href="#psad-rules" class="header-anchor">#</a> PSAD rules</h3> <p>If PSAD Intrusion Detection is to be used, make sure to include the PSAD ruleset in the configuration file (as its not defined by default).</p> <div class="custom-block warning"><p class="custom-block-title">NOTE</p> <p>Make sure that you add the the psad rules include before the local rules.</p></div> <div class="language-xml extra-class"><div class="highlight-lines"><div class="highlighted"> </div><br><br><br></div><pre class="language-xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span><span class="token punctuation">&gt;</span></span>psad_rules.xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span><span class="token punctuation">&gt;</span></span>local_rules.xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rules</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="agent-installation"><a href="#agent-installation" class="header-anchor">#</a> Agent installation</h2> <p>To install OSSEC as an agent is the same approach as when installing the server. Download the <a href="https://github.com/ossec/ossec-hids/releases" target="_blank" rel="noopener noreferrer">latest stable version<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> from ossec-hids GitHub. Download and install the dependencies. Extract the OSSEC source code and run the installation script.</p> <div class="language-console extra-class"><pre class="language-text"><code>client@ubuntu:~$ wget https://github.com/ossec/ossec-hids/archive/3.6.0.tar.gz
client@ubuntu:~$ tar -zxvf 3.6.0.tar.gz
client@ubuntu:~$ cd ossec-hids-3.6.0/
client@ubuntu:~$ wget https://ftp.pcre.org/pub/pcre/pcre2-10.32.tar.gz
client@ubuntu:~$ tar -zxvf pcre2-10.32.tar.gz -C src/external/
client@ubuntu:~$ sudo apt-get install build-essential libssl-dev libpcre2-dev zlib1g-dev
client@ubuntu:~$ sudo PCRE2_SYSTEM=yes ./install.sh
</code></pre></div><div class="language-console extra-class"><div class="highlight-lines"><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><br></div><pre class="language-text"><code>1- What kind of installation do you want (server, agent, local, hybrid or help)? agent

  - Agent(client) installation chosen.

2- Setting up the installation environment.

 - Choose where to install the OSSEC HIDS [/var/ossec]: 

    - Installation will be made at  /var/ossec .

3- Configuring the OSSEC HIDS.

  3.1- What's the IP Address or hostname of the OSSEC HIDS server?: 192.168.0.1

  3.2- Do you want to run the integrity check daemon? (y/n) [y]: y

   - Running syscheck (integrity check daemon).

  3.3- Do you want to run the rootkit detection engine? (y/n) [y]: y

   - Running rootcheck (rootkit detection).

  3.4 - Do you want to enable active response? (y/n) [y]: y
</code></pre></div><h2 id="agent-configuration"><a href="#agent-configuration" class="header-anchor">#</a> Agent configuration</h2> <p>Edit the agent configuration file and verify that the server IP address is correct. Continue with disabling email notifications.</p> <div class="language-console extra-class"><pre class="language-text"><code>client@ubuntu:~$ sudo nano /var/ossec/etc/ossec.conf
</code></pre></div><div class="language-xml extra-class"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ossec_config</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>client</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>server-ip</span><span class="token punctuation">&gt;</span></span>192.168.0.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>server-ip</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>config-profile</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>config-profile</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>client</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>global</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>email_notification</span><span class="token punctuation">&gt;</span></span>no<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>email_notification</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>global</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Proceed and add the following lines after the rootcheck segment to enable active response and repeated offenders.</p> <div class="language-console extra-class"><pre class="language-text"><code>client@ubuntu:~$ sudo nano /var/ossec/etc/ossec.conf
</code></pre></div><div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>command</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>firewall-drop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executable</span><span class="token punctuation">&gt;</span></span>firewall-drop.sh<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executable</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>expect</span><span class="token punctuation">&gt;</span></span>srcip<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>expect</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>timeout_allowed</span><span class="token punctuation">&gt;</span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>timeout_allowed</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>command</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- Active Response Config --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>active-response</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- Specify a comma seperated list of timeouts per
     - re-incidence (in minutes).
    --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repeated_offenders</span><span class="token punctuation">&gt;</span></span>30,60,120,240,480<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repeated_offenders</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>active-response</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>active-response</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- Firewall Drop response. Block the IP for
    - 600 seconds on the firewall (iptables,
    - ipfilter, etc).
    --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>disabled</span><span class="token punctuation">&gt;</span></span>no<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>disabled</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>command</span><span class="token punctuation">&gt;</span></span>firewall-drop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>command</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>agent_id</span><span class="token punctuation">&gt;</span></span>001<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>agent_id</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">&gt;</span></span>local<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rules_id</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rules_id</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>level</span><span class="token punctuation">&gt;</span></span>6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>level</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>timeout</span><span class="token punctuation">&gt;</span></span>600<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>timeout</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>active-response</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="manage-agents"><a href="#manage-agents" class="header-anchor">#</a> Manage agents</h2> <p>To manage an agent we need to add the agent to our OSSEC server. Run the command shown in the code segment below and follow the instructions.</p> <div class="language-console extra-class"><pre class="language-text"><code>server@ubuntu:~$ sudo /var/ossec/bin/manage_agents
</code></pre></div><div class="language-console extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><div class="highlighted"> </div><br></div><pre class="language-text"><code>****************************************
* OSSEC HIDS v3.6.0 Agent manager.     *
* The following options are available: *
****************************************
   (A)dd an agent (A).
   (E)xtract key for an agent (E).
   (L)ist already added agents (L).
   (R)emove an agent (R).
   (Q)uit.
Choose your action: A,E,L,R or Q: A

- Adding a new agent (use '\q' to return to the main menu).
  Please provide the following:
   * A name for the new agent: client@ubuntu
   * The IP Address of the new agent: 192.168.0.2
   * An ID for the new agent[001]: 001
Agent information:
   ID:001
   Name:client@ubuntu
   IP Address:192.168.0.2

Confirm adding it?(y/n): y
</code></pre></div><p>Once we added the client proceed by extracting its agent key by providing the assigned agent ID.</p> <div class="language-console extra-class"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-text"><code>****************************************
* OSSEC HIDS v3.6.0 Agent manager.     *
* The following options are available: *
****************************************
   (A)dd an agent (A).
   (E)xtract key for an agent (E).
   (L)ist already added agents (L).
   (R)emove an agent (R).
   (Q)uit.
Choose your action: A,E,L,R or Q: E

Available agents: 
   ID: 001, Name: client@ubuntu, IP: 192.168.0.2
Provide the ID of the agent to extract the key (or '\q' to quit): 001

Agent key information for '001' is: 
523b0d579891be85956bb3da6c757455005eaf1508ef578186431efbebf5901ecb467ddd857ed5dfdeb5b2cb00e8911c6d031=

** Press ENTER to return to the main menu.
</code></pre></div><p>Copy the agent key and head back to our OSSEC client and import the agent key. Execute the command, shown in the code section below, on the client and paste the key. Validate that our agent information is correct before adding it.</p> <div class="language-console extra-class"><pre class="language-text"><code>client@ubuntu:~$ sudo /var/ossec/bin/manage_agents
</code></pre></div><div class="language-console extra-class"><div class="highlight-lines"><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-text"><code>****************************************
* OSSEC HIDS v3.6.0 Agent manager.     *
* The following options are available: *
****************************************
   (I)mport key from the server (I).
   (Q)uit.
Choose your action: I or Q: i

* Provide the Key generated by the server.
* The best approach is to cut and paste it.
*** OBS: Do not include spaces or new lines.

Paste it here (or '\q' to quit): 
523b0d579891be85956bb3da6c757455005eaf1508ef578186431efbebf5901ecb467ddd857ed5dfdeb5b2cb00e8911c6d031=

Agent information:
   ID:001
   Name:client@ubuntu
   IP Address:192.168.0.2

Confirm adding it?(y/n): y
Added.
</code></pre></div><p>Finally restart the OSSEC server and the client to enable and activate OSSEC HIDS.</p> <div class="language-console extra-class"><pre class="language-text"><code>server@ubuntu:~$ sudo /var/ossec/bin/ossec-control restart
client@ubuntu:~$ sudo /var/ossec/bin/ossec-control restart
</code></pre></div><p>To confirm that our agent now is active run the following command from the server.</p> <div class="language-console extra-class"><div class="highlight-lines"><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><br></div><pre class="language-text"><code>server@ubuntu:~$ sudo /var/ossec/bin/agent_control -lc

OSSEC HIDS agent_control. List of available agents:
   ID: 000, Name: server@ubuntu (server), IP: 127.0.0.1, Active/Local
   ID: 001, Name: client@ubuntu, IP: 192.168.0.2, Active
</code></pre></div><p>If the agent does not appear, make sure that the firewall settings are in place and that correct ports are opened on both environments. See the <a href="#firewall-settings">Firewall settings</a> section for more information</p> <h2 id="firewall-settings"><a href="#firewall-settings" class="header-anchor">#</a> Firewall settings</h2> <p>The firewall being used is UFW (Uncomplicated Firewall). It is set by default to deny incoming traffic, allow outgoing traffic and allow port 22 (OpenSSH). Read more about UFW <a href="https://help.ubuntu.com/community/UFW" target="_blank" rel="noopener noreferrer">here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <details class="custom-block details"><summary>UFW Settings</summary> <div class="language-console extra-class"><pre class="language-text"><code>server@ubuntu:~$ sudo ufw default deny incoming
server@ubuntu:~$ sudo ufw default allow outgoing
server@ubuntu:~$ sudo ufw allow 22
server@ubuntu:~$ sudo ufw enable
Command may disrupt existing ssh connections. Proceed with operation (y|n)? y
Firewall is active and enabled on system startup
</code></pre></div></details> <div class="language-console extra-class"><pre class="language-text"><code>server@ubuntu:~$ sudo ufw allow proto udp from 192.168.0.2 to any port 1514 comment &quot;OSSEC client&quot;
server@ubuntu:~$ sudo ufw allow proto udp from 192.168.0.2 to any port 514 comment &quot;OSSEC client syslog&quot;
client@ubuntu:~$ sudo ufw allow proto udp from 192.168.0.1 to any port 1514 comment &quot;OSSEC server&quot;
client@ubuntu:~$ sudo ufw allow proto udp from 192.168.0.1 to any port 514 comment &quot;OSSEC server syslog&quot;
</code></pre></div><h2 id="slack-integration"><a href="#slack-integration" class="header-anchor">#</a> Slack integration</h2> <p>Download <a href="/img/ossec/512x512.png">OSSEC icon</a> for the Slack App integration.</p> <p>Add the ossec-slack command within the command section of the OSSEC configuration file.</p> <div class="language-console extra-class"><pre class="language-text"><code>server@ubuntu:~$ sudo nano /var/ossec/etc/ossec.conf
</code></pre></div><p>To send all alerts to Slack with the pre-defined alert level, leave the expect segment blank.</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>command</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>ossec-slack<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executable</span><span class="token punctuation">&gt;</span></span>ossec-slack.sh<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executable</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>expect</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>expect</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!-- no expect args required --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>timeout_allowed</span><span class="token punctuation">&gt;</span></span>no<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>timeout_allowed</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>command</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>In the active response section we'll set the alert level.</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>active-response</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>command</span><span class="token punctuation">&gt;</span></span>ossec-slack<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>command</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">&gt;</span></span>server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>level</span><span class="token punctuation">&gt;</span></span>6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>level</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>active-response</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Next edit the <code>ossec-slack.sh</code> file to match our Slack App settings.</p> <div class="language-console extra-class"><pre class="language-text"><code>server@ubuntu:~$ sudo nano /var/ossec/active-response/bin/ossec-slack.sh
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">NOTE</p> <p>Make sure that the log path is correct <code>/../</code> in the ossec-slack.sh file.</p></div> <div class="language-bash extra-class"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br><br><br><br><br><div class="highlighted"> </div><br></div><pre class="language-bash"><code><span class="token assign-left variable">SLACKUSER</span><span class="token operator">=</span><span class="token string">&quot;OSSEC&quot;</span>
<span class="token assign-left variable">CHANNEL</span><span class="token operator">=</span><span class="token string">&quot;#ossec-hids&quot;</span>
<span class="token assign-left variable">SITE</span><span class="token operator">=</span><span class="token string">&quot;https://hooks.slack.com/services/XXXXXXXXX/XXXXXXXX/XXXXXXXXXXX&quot;</span>
<span class="token assign-left variable">SOURCE</span><span class="token operator">=</span><span class="token string">&quot;ossec2slack&quot;</span>
<span class="token punctuation">..</span>.
<span class="token comment"># Logging</span>
<span class="token builtin class-name">cd</span> <span class="token variable">$LOCAL</span>
<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/
<span class="token assign-left variable"><span class="token environment constant">PWD</span></span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">pwd</span><span class="token variable">`</span></span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">`</span><span class="token function">date</span><span class="token variable">`</span></span> <span class="token variable">$0</span> <span class="token variable">$1</span> <span class="token variable">$2</span> <span class="token variable">$3</span> <span class="token variable">$4</span> <span class="token variable">$5</span> <span class="token variable">$6</span> <span class="token variable">$7</span> <span class="token variable">$8</span>&quot;</span> <span class="token operator">&gt;&gt;</span> <span class="token variable">${<span class="token environment constant">PWD</span>}</span>/<span class="token punctuation">..</span>/logs/active-responses.log
</code></pre></div><p>Save the file and reload OSSEC and we should start retrieve alerts to our defined channel.</p> <div class="language- extra-class"><pre class="language-text"><code>server@ubuntu:~$ sudo /var/ossec/bin/ossec-control reload
</code></pre></div><h2 id="cloudflare-integration"><a href="#cloudflare-integration" class="header-anchor">#</a> Cloudflare integration</h2> <div class="custom-block warning"><p class="custom-block-title">NOTE</p> <p>The Cloudflare integration requires you to have the jq (JSON processing) tool installed. This tool is used when removing blocked IP's following the repeated offenders timeout interval.</p></div> <div class="language-console extra-class"><pre class="language-text"><code>server@ubuntu:~$ sudo apt-get install jq
</code></pre></div><p>First add the cloudflare-ban command to the OSSEC configuration file.</p> <div class="language- extra-class"><pre class="language-text"><code>server@ubuntu:~$ sudo nano /var/ossec/etc/ossec.conf
</code></pre></div><div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>command</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>cloudflare-ban<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executable</span><span class="token punctuation">&gt;</span></span>cloudflare-ban.sh<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executable</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>timeout_allowed</span><span class="token punctuation">&gt;</span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>timeout_allowed</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>expect</span><span class="token punctuation">&gt;</span></span>srcip<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>expect</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>command</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>As well to the active response section. Here we set to block all alerts level 6 or greater.</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>active-response</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>command</span><span class="token punctuation">&gt;</span></span>cloudflare-ban<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>command</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">&gt;</span></span>server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>level</span><span class="token punctuation">&gt;</span></span>6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>level</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>timeout</span><span class="token punctuation">&gt;</span></span>43200<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>timeout</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>active-response</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Next proceed to update the <code>cloudflare-ban.sh</code> script and put your Cloudflare username along with your Global API key.</p> <div class="language-console extra-class"><pre class="language-text"><code>server@ubuntu:~$ sudo nano /var/ossec/active-response/bin/cloudflare-ban.sh
</code></pre></div><div class="language-bash extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-bash"><code><span class="token assign-left variable">ACTION</span><span class="token operator">=</span><span class="token variable">$1</span>
<span class="token assign-left variable"><span class="token environment constant">USER</span></span><span class="token operator">=</span><span class="token variable">$2</span>
<span class="token assign-left variable">IP</span><span class="token operator">=</span><span class="token variable">$3</span>
<span class="token assign-left variable"><span class="token environment constant">PWD</span></span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">pwd</span><span class="token variable">`</span></span>
<span class="token assign-left variable">TOKEN</span><span class="token operator">=</span><span class="token string">'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9ey'</span>
<span class="token assign-left variable"><span class="token environment constant">USER</span></span><span class="token operator">=</span><span class="token string">'cloudflareuser@email.com'</span>
<span class="token assign-left variable">MODE</span><span class="token operator">=</span><span class="token string">'block'</span> <span class="token comment"># block or challenge</span>
</code></pre></div><p>Save the changes and reload OSSEC.</p> <div class="language-console extra-class"><pre class="language-text"><code>server@ubuntu:~$ sudo /var/ossec/bin/ossec-control reload
</code></pre></div><p>To monitor the blocked IP address within the Cloudflare account, go to Firewall, Tools and under IP Access Rules.</p> <h2 id="monitoring"><a href="#monitoring" class="header-anchor">#</a> Monitoring</h2> <div class="custom-block tip"><p class="custom-block-title">INFO</p> <p>If not using Monit you can skip this step.</p></div> <p>To monitor if the OSSEC daemons are running accordingly, we use Monit to monitor the current status. Edit the Monit configuration file and add the lines below, continue with reloading the Monit daemon to apply the new monitoring rules. If working correctly we shall now receive M/Monit alerts saying processes is not running.</p> <div class="language-console extra-class"><pre class="language-text"><code>client@ubuntu:~$ sudo nano /usr/local/etc/monitrc
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># OSSEC processes</span>
check process ossec-agentd matching <span class="token string">&quot;ossec-agentd&quot;</span>
check process ossec-execd matching <span class="token string">&quot;ossec-execd&quot;</span>
check process ossec-logcollector matching <span class="token string">&quot;ossec-logcollector&quot;</span>
check process ossec-syscheckd matching <span class="token string">&quot;ossec-syscheckd&quot;</span>
</code></pre></div><p>Save and reload Monit.</p> <div class="language-console extra-class"><pre class="language-text"><code>client@ubuntu:~$ cd /usr/local/
client@ubuntu:~$ sudo ./bin/monit reload
</code></pre></div><h3 id="monitor-failed-m-monit-login-attempts-with-ossec"><a href="#monitor-failed-m-monit-login-attempts-with-ossec" class="header-anchor">#</a> Monitor failed M/Monit login attempts with OSSEC</h3> <p>Add the M/Monit error.log path to the OSSEC monitor section (local files).</p> <div class="language-console extra-class"><pre class="language-text"><code>client@ubuntu:~$ sudo nano /var/ossec/etc/ossec.conf
</code></pre></div><div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>localfile</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log_format</span><span class="token punctuation">&gt;</span></span>syslog<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log_format</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">&gt;</span></span>/usr/local/mmonit-3.7.2/logs/error.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>localfile</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Go to the OSSEC server and add the custom rule to the <code>local_rules.xml</code> file.</p> <div class="language-console extra-class"><pre class="language-text"><code>server@ubuntu:~$ sudo nano /var/ossec/rules/local_rules.xml
</code></pre></div><div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>100101<span class="token punctuation">&quot;</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>6<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_sid</span><span class="token punctuation">&gt;</span></span>2501<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_sid</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>match</span><span class="token punctuation">&gt;</span></span>Unauthorized, authentication failed for<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>match</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span><span class="token punctuation">&gt;</span></span>authentication_failed,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>group</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>User authentication failure.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Save and reload the OSSEC server.</p> <div class="language-console extra-class"><pre class="language-text"><code>server@ubuntu:~$ sudo /var/ossec/bin/ossec-control reload
</code></pre></div><h2 id="upgrading"><a href="#upgrading" class="header-anchor">#</a> Upgrading</h2> <p>To upgrade OSSEC, download the <a href="https://github.com/ossec/ossec-hids/releases" target="_blank" rel="noopener noreferrer">latest release<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, extract the file and run the install script. The installer will tell if OSSEC is already installed and if you wish to update it.</p> <div class="language-console extra-class"><pre class="language-text"><code>server@ubuntu:~$ wget https://github.com/ossec/ossec-hids/archive/3.6.0.tar.gz
server@ubuntu:~$ tar -zxvf 3.6.0.tar.gz
server@ubuntu:~$ cd ossec-hids-3.6.0/
server@ubuntu:~$ wget https://ftp.pcre.org/pub/pcre/pcre2-10.32.tar.gz
server@ubuntu:~$ tar -zxvf pcre2-10.32.tar.gz -C src/external/
server@ubuntu:~$ sudo apt-get install build-essential libssl-dev libpcre2-dev zlib1g-dev
server@ubuntu:~$ sudo PCRE2_SYSTEM=yes ./install
</code></pre></div><h3 id="upgrade-to-ossec-3-3-0"><a href="#upgrade-to-ossec-3-3-0" class="header-anchor">#</a> Upgrade to OSSEC 3.3.0</h3> <p>To upgrade to OSSEC 3.3.0 using the pcre2 package, download the new version along with the pcre2 package, extract and upgrade OSSEC as normal.</p> <div class="language-console extra-class"><pre class="language-text"><code>server@ubuntu:~$ wget https://github.com/ossec/ossec-hids/archive/3.3.0.tar.gz
server@ubuntu:~$ tar -zxvf 3.3.0.tar.gz
server@ubuntu:~$ cd ossec-hids-3.3.0/
server@ubuntu:~$ wget https://ftp.pcre.org/pub/pcre/pcre2-10.32.tar.gz
server@ubuntu:~$ tar -zxvf pcre2-10.32.tar.gz -C src/external/
server@ubuntu:~$ sudo apt-get install build-essential libssl-dev libpcre2-dev zlib1g-dev
server@ubuntu:~$ sudo PCRE2_SYSTEM=yes ./install
</code></pre></div><div class="language-console extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br></div><pre class="language-text"><code>OSSEC HIDS v2.9.3 Installation Script - http://www.ossec.net
 
You are about to start the installation process of the OSSEC HIDS.
You must have a C compiler pre-installed in your system.
 
    - System: Linux hostname 4.4.0-116-generic
    - User: root
    - Host: hostname

    -- Press ENTER to continue or Ctrl-C to abort. --

    - You already have OSSEC installed. Do you want to update it? (y/n): y
</code></pre></div><h2 id="custom-rules"><a href="#custom-rules" class="header-anchor">#</a> Custom rules</h2> <p>Read more about how to create custom rules and decoders <a href="https://www.ossec.net/docs/manual/rules-decoders/create-custom.html" target="_blank" rel="noopener noreferrer">here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <ul><li><a href="https://github.com/libellux/Libellux-Up-and-Running/blob/master/docs/ossec/config/local_rules.xml" target="_blank" rel="noopener noreferrer">local_rules.xml<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="ignore-snap-loop-devices"><a href="#ignore-snap-loop-devices" class="header-anchor">#</a> Ignore snap loop devices</h3> <p><code>/var/ossec/rules/local_rules.xml</code></p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>100100<span class="token punctuation">&quot;</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_sid</span><span class="token punctuation">&gt;</span></span>531<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_sid</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>regex</span><span class="token punctuation">&gt;</span></span>'df -P':\s+/dev/loop\d+\s+\d+\s+\d+\s+0\s+100%\s+/snap/\w+/\d+<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>regex</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>Ignore full snap loop devices.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="monitor-failed-m-monit-authentication"><a href="#monitor-failed-m-monit-authentication" class="header-anchor">#</a> Monitor failed M/Monit authentication</h3> <p><code>/var/ossec/rules/local_rules.xml</code></p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>100101<span class="token punctuation">&quot;</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>6<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_sid</span><span class="token punctuation">&gt;</span></span>2501<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_sid</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>match</span><span class="token punctuation">&gt;</span></span>Unauthorized, authentication failed for<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>match</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span><span class="token punctuation">&gt;</span></span>authentication_failed,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>group</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>User authentication failure.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>/var/ossec/etc/oseec.conf</code></p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>localfile</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log_format</span><span class="token punctuation">&gt;</span></span>syslog<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log_format</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">&gt;</span></span>/usr/local/mmonit-3.7.2/logs/error.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>localfile</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="mute-useless-systemd-resolved-message"><a href="#mute-useless-systemd-resolved-message" class="header-anchor">#</a> Mute useless systemd-resolved message</h3> <p><code>/var/ossec/rules/local_rules.xml</code></p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>100102<span class="token punctuation">&quot;</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>program_name</span><span class="token punctuation">&gt;</span></span>systemd-resolved<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>program_name</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>match</span><span class="token punctuation">&gt;</span></span>Server returned error NXDOMAIN<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>match</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>Useless systemd-resolved log message.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="alert-on-fail2ban-action"><a href="#alert-on-fail2ban-action" class="header-anchor">#</a> Alert on fail2ban action</h3> <p><code>/var/ossec/rules/local_rules.xml</code></p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>100103<span class="token punctuation">&quot;</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>6<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>match</span><span class="token punctuation">&gt;</span></span>fail2ban.actions<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>match</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span><span class="token punctuation">&gt;</span></span>authentication_failed,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>group</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>Fail2ban action taken.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>/var/ossec/etc/oseec.conf</code></p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>localfile</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log_format</span><span class="token punctuation">&gt;</span></span>syslog<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log_format</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">&gt;</span></span>/var/log/fail2ban.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>localfile</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="command-line"><a href="#command-line" class="header-anchor">#</a> Command-line</h2> <table><thead><tr><th>Command</th> <th>Description</th></tr></thead> <tbody><tr><td>/var/ossec/bin/agent_control -lc</td> <td>List all active agents</td></tr> <tr><td>/var/ossec/bin/ossec-logtest</td> <td>Logtest</td></tr> <tr><td>/var/ossec/bin/ossec-control</td> <td>start,stop,reload,restart,status,enable,disable</td></tr> <tr><td>/var/ossec/bin/manage_agents</td> <td>manage agents (e.g., add, remove)</td></tr></tbody></table> <h2 id="troubleshooting"><a href="#troubleshooting" class="header-anchor">#</a> Troubleshooting</h2> <p>If you encounter any issue or having questions regarding OSSEC I recommend using their very helpful <a href="https://groups.google.com/forum/#!forum/ossec-list" target="_blank" rel="noopener noreferrer">mailing list<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>You can also read more about debug mode and how to view more verbose logs <a href="https://www.ossec.net/docs/faq/unexpected.html" target="_blank" rel="noopener noreferrer">here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h3 id="duplicate-counter-error"><a href="#duplicate-counter-error" class="header-anchor">#</a> Duplicate counter error</h3> <p>In the OSSEC log (/var/ossec/logs/ossec.log) you might notice that the log gets filled with warnings and errors as shown below.</p> <div class="language-log extra-class"><pre class="language-text"><code>2019/02/21 13:33:21 ossec-remoted: WARN: Duplicate error: [...]
2019/02/21 13:33:21 ossec-remoted(1407): ERROR: Duplicated counter for [...]
</code></pre></div><p>Stop both the OSSEC manager and the agent. In the agent server go to /var/ossec/queue/rids and remove all the files within the folder. At the manager server go into /var/ossec/queue/rids and remove the file corresponding to the agents ID. Do not delete the sender_counter. Restart both.</p> <p>Or disable the feature by editing <code>/var/ossec/etc/internal_options.conf</code></p> <div class="language- extra-class"><pre><code># Verify msg id (set to 0 to disable it)
remoted.verify_msg_id=0
</code></pre></div><p>Save and restart.</p> <h3 id="build-essential"><a href="#build-essential" class="header-anchor">#</a> build-essential</h3> <p>If receiving build error <code>./install.sh: 105: make: not found</code> install the build-essential package <code>sudo apt-get install build-essential</code>.</p> <h3 id="libevent-dev"><a href="#libevent-dev" class="header-anchor">#</a> libevent-dev</h3> <p>If receiving the build error below, install the libevent development package <code>sudo apt-get install libevent-dev</code>.</p> <div class="language- extra-class"><pre><code>os_maild/sendmail.c:12:10: fatal error: event.h: No such file or directory
12 | #include &lt;event.h&gt;
   |          ^~~~~~~~~
compilation terminated.
make: *** [Makefile:926: os_maild/sendmail.o] Error 1
</code></pre></div><h3 id="pcre2-libpcre2-dev"><a href="#pcre2-libpcre2-dev" class="header-anchor">#</a> pcre2 &amp; libpcre2-dev</h3> <p>If receiving the build error <code>./os_regex/os_regex.h:19:10: fatal error: pcre2.h: No such file or directory</code> download and install pcre2 package (version 10.32) found <a href="https://ftp.pcre.org/pub/pcre/" target="_blank" rel="noopener noreferrer">here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <div class="language-console extra-class"><pre class="language-text"><code>server@ubuntu:~$ wget https://ftp.pcre.org/pub/pcre/pcre2-10.32.tar.gz
server@ubuntu:~$ tar -zxvf pcre2-10.32.tar.gz -C src/external/
</code></pre></div><p>If the build error persist, make sure to install the libpcre2 development package <code>sudo apt-get install libpcre2-dev</code>.</p> <h3 id="zlib1g-dev"><a href="#zlib1g-dev" class="header-anchor">#</a> zlib1g-dev</h3> <p>If receiving the build error <code>os_zlib/os_zlib.c:13:10: fatal error: zlib.h: No such file or directory</code> install the zlib1g development package <code>sudo apt-get install zlib1g-dev</code>.</p> <h3 id="libssl-dev"><a href="#libssl-dev" class="header-anchor">#</a> libssl-dev</h3> <p>If receiving the build error <code>./external/compat/includes.h:65:10: fatal error: openssl/opensslv.h: No such file or directory</code> install the libssl development package <code>sudo apt-get install libssl-dev</code>.</p> <h3 id="ignore-snap-partition-state"><a href="#ignore-snap-partition-state" class="header-anchor">#</a> Ignore snap partition state</h3> <p>If receiving multiple snap partition usage alerts, add a custom rule to local_rules.xml.</p> <div class="language- extra-class"><pre class="language-text"><code>Rule: 531 (level 7) -&gt; 'Partition usage reached 100% (disk space monitor).'
ossec: output: 'df -P': /dev/loop0           27776   27776         0     100% /snap/snapd/7264
</code></pre></div><div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>100100<span class="token punctuation">&quot;</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_sid</span><span class="token punctuation">&gt;</span></span>531<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_sid</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>regex</span><span class="token punctuation">&gt;</span></span>'df -P':\s+/dev/loop\d+\s+\d+\s+\d+\s+0\s+100%\s+/snap/\w+/\d+<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>regex</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>Ignore full snap loop devices<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="server-returned-error-nxdomain"><a href="#server-returned-error-nxdomain" class="header-anchor">#</a> Server returned error NXDOMAIN</h3> <p>If receiving multiple systemd-resolved regarding NXDOMAIN and potential DNS violation, add a custom rule to local_rules.xml.</p> <div class="language- extra-class"><pre class="language-text"><code>systemd-resolved[3225]: message repeated 4 times: [ Server returned error NXDOMAIN, mitigating potential DNS violation DVE-2018-0001, retrying transaction with reduced feature level UDP.]
</code></pre></div><div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>100102<span class="token punctuation">&quot;</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>program_name</span><span class="token punctuation">&gt;</span></span>systemd-resolved<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>program_name</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>match</span><span class="token punctuation">&gt;</span></span>Server returned error NXDOMAIN<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>match</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>Useless systemd-resolved log message.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="cannot-unlink-queue-rids-sender"><a href="#cannot-unlink-queue-rids-sender" class="header-anchor">#</a> Cannot unlink /queue/rids/sender</h3> <p>If receiving the error message shown below.</p> <div class="language-console extra-class"><pre class="language-text"><code>2020/08/09 20:04:17 manage_agents: ERROR: Cannot unlink /queue/rids/sender: No such file or directory
Added.
</code></pre></div><p>Proceed with creating the missing file <code>sudo touch /queue/rids/sender</code>.</p> <h2 id="recommended-reading"><a href="#recommended-reading" class="header-anchor">#</a> Recommended reading <span class="badge warning" style="vertical-align:top;" data-v-15b7b770>affiliate links</span></h2> <ul><li><a href="https://amzn.to/33sOjdF" target="_blank" rel="noopener noreferrer">Instant OSSEC Host-based Intrusion Detection, Lhotsky Brad, 2013<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://amzn.to/2XuL9lM" target="_blank" rel="noopener noreferrer">OSSEC Host-Based Intrusion Detection Guide, Rory Bray, 2008<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h2 id="enterprise-solutions"><a href="#enterprise-solutions" class="header-anchor">#</a> Enterprise solutions <span class="badge default" style="vertical-align:top;" data-v-15b7b770>non-sponsored</span></h2> <h3 id="atomic-enterprise-ossec"><a href="#atomic-enterprise-ossec" class="header-anchor">#</a> Atomic Enterprise OSSEC</h3> <p>Atomic Enterprise OSSEC is built specifically for organizations that need to leverage OSSEC in large or mission critical environments. With a dedicated management console, thousands of pre-built OSSEC rules, compliance reporting, and more, Atomic Enterprise OSSEC makes it easy to deploy, manage, and use OSSEC in any on-premise, cloud, or hybrid environment.</p> <p><a href="https://atomicorp.com/atomic-enterprise-ossec/" target="_blank" rel="noopener noreferrer">Atomic Enterprise OSSEC<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <!----></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/libellux/Libellux-Up-and-Running/edit/master/docs/ossec/README.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/13/2020, 7:46:04 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/wireguard/" class="prev">
        WireGuard Secure VPN Tunnel
      </a></span> <span class="next"><a href="/psad/">
        PSAD Intrusion Detection
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----></div></div>
    <script src="/assets/js/app.05a4ee0a.js" defer></script><script src="/assets/js/2.716680d4.js" defer></script><script src="/assets/js/14.98e47507.js" defer></script><script src="/assets/js/5.06c58baa.js" defer></script><script src="/assets/js/4.99009925.js" defer></script><script src="/assets/js/3.8dada23c.js" defer></script>
  </body>
</html>
